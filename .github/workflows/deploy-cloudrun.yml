name: Deploy to Google Cloud Run

on:
  push:
    branches: [ main ]
    paths:
      - 'api/**'
      - 'worker/**'
      - 'migrate/**'
      - 'db/migrations/**'
      - '.github/workflows/deploy-cloudrun.yml'
  workflow_dispatch:

concurrency:
  group: deploy-cloudrun-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

env:
  # ===== GCP & GAR (pakai Repository Variables) =====
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  # contoh: asia-southeast2-docker.pkg.dev/linkedin-scraper-474706/leads
  GAR_REPO: ${{ vars.GAR_REPO }}

  # ===== Cloud Run services & job =====
  API_SERVICE: leads-api
  WORKER_SERVICE: leads-worker
  MIGRATE_JOB_NAME: db-migrate
  # SA runtime khusus job migrasi (sudah dibuat & diberi secretAccessor)
  MIGRATE_JOB_SA: leads-job-sa@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com

  # ===== Image names =====
  API_IMAGE_NAME: api
  WORKER_IMAGE_NAME: worker
  MIGRATE_IMAGE_NAME: migrate

  # ===== Dockerfiles =====
  API_DOCKERFILE: api/Dockerfile
  WORKER_DOCKERFILE: worker/Dockerfile
  MIGRATE_DOCKERFILE: migrate/Dockerfile

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Auth OIDC (tanpa JSON key) ----
      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Docker auth to Artifact Registry
        run: |
          set -euo pipefail
          HOST="$(echo '${{ env.GAR_REPO }}' | cut -d/ -f1)"
          gcloud auth configure-docker "$HOST" --quiet

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---- Hitung tag image berdasarkan short SHA ----
      - name: Compute image names
        id: images
        run: |
          set -euo pipefail
          GIT_SHA="$(git rev-parse --short HEAD)"
          echo "git_sha=${GIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "api_image=${{ env.GAR_REPO }}/${{ env.API_IMAGE_NAME }}:${GIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "worker_image=${{ env.GAR_REPO }}/${{ env.WORKER_IMAGE_NAME }}:${GIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "migrate_image=${{ env.GAR_REPO }}/${{ env.MIGRATE_IMAGE_NAME }}:${GIT_SHA}" >> "$GITHUB_OUTPUT"

      # ---- Build & push (with registry cache) ----
      - name: Build & Push API (with cache)
        uses: docker/build-push-action@v5
        with:
          context: api
          file: ${{ env.API_DOCKERFILE }}
          push: true
          tags: |
            ${{ steps.images.outputs.api_image }}
            ${{ env.GAR_REPO }}/${{ env.API_IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.GAR_REPO }}/${{ env.API_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.GAR_REPO }}/${{ env.API_IMAGE_NAME }}:buildcache,mode=max
          provenance: false

      - name: Build & Push Worker (with cache)
        uses: docker/build-push-action@v5
        with:
          context: worker
          file: ${{ env.WORKER_DOCKERFILE }}
          push: true
          tags: |
            ${{ steps.images.outputs.worker_image }}
            ${{ env.GAR_REPO }}/${{ env.WORKER_IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.GAR_REPO }}/${{ env.WORKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.GAR_REPO }}/${{ env.WORKER_IMAGE_NAME }}:buildcache,mode=max
          provenance: false

      - name: Build & Push Migrate (with cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.MIGRATE_DOCKERFILE }}
          push: true
          tags: |
            ${{ steps.images.outputs.migrate_image }}
            ${{ env.GAR_REPO }}/${{ env.MIGRATE_IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.GAR_REPO }}/${{ env.MIGRATE_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.GAR_REPO }}/${{ env.MIGRATE_IMAGE_NAME }}:buildcache,mode=max
          provenance: false

      # ---- Deploy Cloud Run Job (migrasi) ----
      - name: Deploy Cloud Run job (migration)
        run: |
          set -euo pipefail
          # Secret "DATABASE_URL" harus ada di Secret Manager project ini
          gcloud run jobs deploy "${{ env.MIGRATE_JOB_NAME }}" \
            --image "${{ steps.images.outputs.migrate_image }}" \
            --region "${{ env.REGION }}" \
            --project "${{ env.PROJECT_ID }}" \
            --service-account "${{ env.MIGRATE_JOB_SA }}" \
            --max-retries=1 \
            --task-timeout=900s \
            --set-secrets=DATABASE_URL=DATABASE_URL:latest
            # Jika DB via Private IP (Cloud SQL) + VPC connector:
            # --vpc-connector=<NAMA_CONNECTOR> --egress-settings=all-traffic

      - name: Run migration job (blocks deploy on failure)
        run: |
          set -euo pipefail
          if ! gcloud run jobs execute "${{ env.MIGRATE_JOB_NAME }}" \
            --project "${{ env.PROJECT_ID }}" \
            --region "${{ env.REGION }}" \
            --wait; then
            EXIT_CODE=$?
            echo "::warning::Migration job failed. Fetching execution details..."
            LAST_EXECUTION="$(gcloud run jobs executions list "${{ env.MIGRATE_JOB_NAME }}" \
              --project "${{ env.PROJECT_ID }}" \
              --region "${{ env.REGION }}" \
              --limit=1 \
              --sort-by=~createTime \
              --format='value(name)' || true)"
            if [ -n "${LAST_EXECUTION}" ]; then
              echo "::group::db-migrate execution describe"
              gcloud run jobs executions describe "${LAST_EXECUTION}" \
                --project "${{ env.PROJECT_ID }}" \
                --region "${{ env.REGION }}" || true
              echo "::endgroup::"

              echo "::group::db-migrate execution logs"
              gcloud run jobs executions get-logs "${LAST_EXECUTION}" \
                --project "${{ env.PROJECT_ID }}" \
                --region "${{ env.REGION }}" || true
              echo "::endgroup::"
            else
              echo "::error::Unable to determine failed execution name."
            fi
            exit "${EXIT_CODE}"
          fi

      # ---- Deploy API ----
      - name: Deploy API to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.API_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ steps.images.outputs.api_image }}
          project_id: ${{ env.PROJECT_ID }}
          flags: --allow-unauthenticated

      # ---- Deploy Worker (private) ----
      - name: Deploy Worker to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.WORKER_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ steps.images.outputs.worker_image }}
          project_id: ${{ env.PROJECT_ID }}
          flags: --no-allow-unauthenticated

      - name: Show URLs
        run: |
          set -euo pipefail
          API_URL="$(gcloud run services describe '${{ env.API_SERVICE }}' --region '${{ env.REGION }}' --format='value(status.url)')"
          WORKER_URL="$(gcloud run services describe '${{ env.WORKER_SERVICE }}' --region '${{ env.REGION }}' --format='value(status.url)')"
          echo "API URL: ${API_URL}"
          echo "WORKER URL: ${WORKER_URL}"
