name: Deploy to Google Cloud Run

on:
  push:
    branches: [ main ]
    paths:
      - 'api/**'
      - 'worker/**'
      - '.github/workflows/deploy-cloudrun.yml'
  workflow_dispatch:

concurrency:
  group: deploy-cloudrun-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  # Host + repo GAR; kamu sudah simpan penuh sebagai GAR_REPO:
  # contoh: asia-southeast2-docker.pkg.dev/linkedin-scraper-474706/leads
  GAR_REPO: ${{ vars.GAR_REPO }}

  # Sesuaikan nama service Cloud Run kamu
  API_SERVICE: leads-api
  WORKER_SERVICE: leads-worker
  MIGRATE_JOB_NAME: db-migrate

  API_IMAGE_NAME: api
  WORKER_IMAGE_NAME: worker
  MIGRATE_IMAGE_NAME: migrate

  API_DOCKERFILE: api/Dockerfile
  WORKER_DOCKERFILE: worker/Dockerfile
  MIGRATE_DOCKERFILE: migrate/Dockerfile

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OIDC login (tanpa JSON key)
      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Docker auth to Artifact Registry
        run: |
          # ambil prefix host dari GAR_REPO, misal: asia-southeast2-docker.pkg.dev
          HOST="$(echo '${{ env.GAR_REPO }}' | cut -d/ -f1)"
          gcloud auth configure-docker "$HOST" --quiet

      - name: Compute image names
        id: images
        run: |
          GIT_SHA="$(git rev-parse --short HEAD)"
          API_IMAGE="${{ env.GAR_REPO }}/${{ env.API_IMAGE_NAME }}:${GIT_SHA}"
          WORKER_IMAGE="${{ env.GAR_REPO }}/${{ env.WORKER_IMAGE_NAME }}:${GIT_SHA}"
          echo "git_sha=${GIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "api_image=${API_IMAGE}" >> "$GITHUB_OUTPUT"
          echo "worker_image=${WORKER_IMAGE}" >> "$GITHUB_OUTPUT"

      - name: Build & push migrate image
        id: migimg
        run: |
          set -euo pipefail
          GIT_SHA="${{ steps.images.outputs.git_sha }}"
          MIGRATE_IMAGE="${{ env.GAR_REPO }}/${{ env.MIGRATE_IMAGE_NAME }}:${GIT_SHA}"
          docker build \
            --file "${{ env.MIGRATE_DOCKERFILE }}" \
            --tag "${MIGRATE_IMAGE}" \
            .
          docker push "${MIGRATE_IMAGE}"
          echo "migrate_image=${MIGRATE_IMAGE}" >> "$GITHUB_OUTPUT"

      - name: Build API image
        run: |
          docker build \
            --file "${{ env.API_DOCKERFILE }}" \
            --tag "${{ steps.images.outputs.api_image }}" \
            api

      - name: Push API image
        run: docker push "${{ steps.images.outputs.api_image }}"

      - name: Build Worker image
        run: |
          docker build \
            --file "${{ env.WORKER_DOCKERFILE }}" \
            --tag "${{ steps.images.outputs.worker_image }}" \
            worker

      - name: Push Worker image
        run: docker push "${{ steps.images.outputs.worker_image }}"

      - name: Deploy Cloud Run job for migrations
        id: deploy-migrate-job
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          JOB_NAME: ${{ env.MIGRATE_JOB_NAME }}
          MIGRATE_IMAGE: ${{ steps.migimg.outputs.migrate_image }}
          DATABASE_URL_FALLBACK: ${{ secrets.DATABASE_URL }}
          DEPLOYER_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        run: |
          set -euo pipefail
          SECRET_FLAGS="--set-secrets=DATABASE_URL=projects/${PROJECT_ID}/secrets/DATABASE_URL:latest"
          if ! gcloud secrets describe DATABASE_URL --project "${PROJECT_ID}" >/dev/null 2>&1; then
            if [ -z "${DATABASE_URL_FALLBACK}" ]; then
              echo "::error::Secret Manager entry DATABASE_URL is missing and DATABASE_URL fallback from GitHub Secrets is not provided."
              exit 1
            fi
            SECRET_FLAGS="--set-env-vars=DATABASE_URL=${DATABASE_URL_FALLBACK}"
            echo "::warning::Falling back to GitHub Actions secret for DATABASE_URL. Prefer Secret Manager to avoid value exposure in Cloud Run job history."
          fi

          SERVICE_ACCOUNT="${DEPLOYER_SERVICE_ACCOUNT}"

          gcloud run jobs deploy "${JOB_NAME}" \
            --image "${MIGRATE_IMAGE}" \
            --region "${REGION}" \
            --project "${PROJECT_ID}" \
            --service-account "${SERVICE_ACCOUNT}" \
            --max-retries=1 \
            --task-timeout=900s \
            ${SECRET_FLAGS}

      - name: Run migration job (blocks deploy on failure)
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          JOB_NAME: ${{ env.MIGRATE_JOB_NAME }}
        run: |
          set -euo pipefail
          gcloud run jobs execute "${JOB_NAME}" \
            --project "${PROJECT_ID}" \
            --region "${REGION}" \
            --wait

      - name: Deploy API to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.API_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ steps.images.outputs.api_image }}
          project_id: ${{ env.PROJECT_ID }}
          allow_unauthenticated: true
          # uncomment kalau mau set ENV dari GitHub Secrets:
          # flags: >
          #   --set-env-vars=DATABASE_URL=${{ secrets.DATABASE_URL }},
          #   JWT_SECRET=${{ secrets.JWT_SECRET }},
          #   GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }},
          #   WORKER_BASE_URL=https://<worker-url>

      - name: Deploy Worker to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.WORKER_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ steps.images.outputs.worker_image }}
          project_id: ${{ env.PROJECT_ID }}
          allow_unauthenticated: false

      - name: Show URLs
        run: |
          API_URL="$(gcloud run services describe '${{ env.API_SERVICE }}' --region '${{ env.REGION }}' --format='value(status.url)')"
          WORKER_URL="$(gcloud run services describe '${{ env.WORKER_SERVICE }}' --region '${{ env.REGION }}' --format='value(status.url)')"
          echo "API URL: ${API_URL}"
          echo "WORKER URL: ${WORKER_URL}"
