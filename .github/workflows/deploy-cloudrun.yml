name: Deploy to Google Cloud Run

on:
  push:
    branches: [ main ]
    paths:
      - 'api/**'
      - 'worker/**'
      - 'migrate/**'
      - '.github/workflows/deploy-cloudrun.yml'
  workflow_dispatch:

concurrency:
  group: deploy-cloudrun-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

env:
  # ===== GCP & GAR (gunakan Repository Variables) =====
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  # Contoh: asia-southeast2-docker.pkg.dev/linkedin-scraper-474706/leads
  GAR_REPO: ${{ vars.GAR_REPO }}

  # ===== Cloud Run services & job =====
  API_SERVICE: leads-api
  WORKER_SERVICE: leads-worker
  MIGRATE_JOB_NAME: db-migrate
  # SA runtime untuk job migrasi (sudah kamu buat & beri secretAccessor)
  MIGRATE_JOB_SA: leads-job-sa@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com
  # Jika ingin pakai run-deployer@..., ganti di atas.

  # ===== Image names (dalam satu repo GAR) =====
  API_IMAGE_NAME: api
  WORKER_IMAGE_NAME: worker
  MIGRATE_IMAGE_NAME: migrate

  # ===== Dockerfiles =====
  API_DOCKERFILE: api/Dockerfile
  WORKER_DOCKERFILE: worker/Dockerfile
  MIGRATE_DOCKERFILE: migrate/Dockerfile

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Auth OIDC (tanpa JSON key) ----
      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Docker auth to Artifact Registry
        run: |
          set -euo pipefail
          HOST="$(echo '${{ env.GAR_REPO }}' | cut -d/ -f1)"
          gcloud auth configure-docker "$HOST" --quiet

      # ---- Hitung tag image berdasarkan short SHA ----
      - name: Compute image names
        id: images
        run: |
          set -euo pipefail
          GIT_SHA="$(git rev-parse --short HEAD)"
          echo "git_sha=${GIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "api_image=${{ env.GAR_REPO }}/${{ env.API_IMAGE_NAME }}:${GIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "worker_image=${{ env.GAR_REPO }}/${{ env.WORKER_IMAGE_NAME }}:${GIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "migrate_image=${{ env.GAR_REPO }}/${{ env.MIGRATE_IMAGE_NAME }}:${GIT_SHA}" >> "$GITHUB_OUTPUT"

      # ---- Build & push images (migrate, api, worker) ----
      - name: Build & push migrate image
        run: |
          set -euo pipefail
          docker build \
            --file "${{ env.MIGRATE_DOCKERFILE }}" \
            --tag "${{ steps.images.outputs.migrate_image }}" \
            .
          docker push "${{ steps.images.outputs.migrate_image }}"

      - name: Build API image
        run: |
          set -euo pipefail
          docker build \
            --file "${{ env.API_DOCKERFILE }}" \
            --tag "${{ steps.images.outputs.api_image }}" \
            api

      - name: Push API image
        run: |
          set -euo pipefail
          docker push "${{ steps.images.outputs.api_image }}"

      - name: Build Worker image
        run: |
          set -euo pipefail
          docker build \
            --file "${{ env.WORKER_DOCKERFILE }}" \
            --tag "${{ steps.images.outputs.worker_image }}" \
            worker

      - name: Push Worker image
        run: |
          set -euo pipefail
          docker push "${{ steps.images.outputs.worker_image }}"

      # ---- Deploy Cloud Run Job untuk migrasi (pakai Secret Manager) ----
      - name: Deploy Cloud Run job (migration)
        run: |
          set -euo pipefail
          # Pastikan Secret Manager memiliki secret "DATABASE_URL" & SA job punya roles/secretmanager.secretAccessor
          gcloud run jobs deploy "${{ env.MIGRATE_JOB_NAME }}" \
            --image "${{ steps.images.outputs.migrate_image }}" \
            --region "${{ env.REGION }}" \
            --project "${{ env.PROJECT_ID }}" \
            --service-account "${{ env.MIGRATE_JOB_SA }}" \
            --max-retries=1 \
            --task-timeout=900s \
            --set-secrets=DATABASE_URL=DATABASE_URL:latest
            # Jika DB via Private IP (Cloud SQL) + VPC:
            # --vpc-connector=<NAMA_CONNECTOR> --egress-settings=all-traffic

      # ---- Eksekusi job migrasi & blok deploy kalau gagal ----
      - name: Run migration job (blocks deploy on failure)
        run: |
          set -euo pipefail
          gcloud run jobs execute "${{ env.MIGRATE_JOB_NAME }}" \
            --project "${{ env.PROJECT_ID }}" \
            --region "${{ env.REGION }}" \
            --wait

      # ---- Deploy API ----
      - name: Deploy API to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.API_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ steps.images.outputs.api_image }}
          project_id: ${{ env.PROJECT_ID }}
          allow_unauthenticated: true
          # Jika ingin set ENV dari Secrets Actions (tidak disarankan bila sudah di-set di Cloud Run / Secret Manager):
          # flags: >
          #   --set-env-vars=JWT_SECRET=${{ secrets.JWT_SECRET }},
          #   GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }},
          #   WORKER_BASE_URL=https://<worker-url>

      # ---- Deploy Worker (private) ----
      - name: Deploy Worker to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.WORKER_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ steps.images.outputs.worker_image }}
          project_id: ${{ env.PROJECT_ID }}
          allow_unauthenticated: false

      # ---- Tampilkan URL Service ----
      - name: Show URLs
        run: |
          set -euo pipefail
          API_URL="$(gcloud run services describe '${{ env.API_SERVICE }}' --region '${{ env.REGION }}' --format='value(status.url)')"
          WORKER_URL="$(gcloud run services describe '${{ env.WORKER_SERVICE }}' --region '${{ env.REGION }}' --format='value(status.url)')"
          echo "API URL: ${API_URL}"
          echo "WORKER URL: ${WORKER_URL}"
